{"items":[{"content":{"body":"## Problem\nDuring concept refinement, the LLM returns a JSON array of strings instead of the expected JSON object with `name`, `description`, and `manifestations` fields.\n\n## Evidence from logs\n```\n2026-01-25 23:12:22 [ERROR] Concept refinement returned invalid JSON structure: [\"The Circuit Pulse is detected in the Quantum Entanglement Ring...\", \"It manifests as a subtle but persistent rhythm...\", \"The Circuit Pulse influences the behavior...\"]\n```\n\nThis happens repeatedly across iterations 6-10, causing:\n- Failed refinement cycles\n- Wasted API calls\n- Eventually failing to meet quality threshold\n\n## Expected behavior\nThe LLM should return:\n```json\n{\n  \"name\": \"The Circuit Pulse\",\n  \"description\": \"...\",\n  \"manifestations\": \"...\"\n}\n```\n\n## Actual behavior\nThe LLM returns:\n```json\n[\"Description 1\", \"Description 2\", \"Description 3\"]\n```\n\n## Proposed solutions\n1. **Improve prompt clarity** - Add explicit JSON structure example in the refinement prompt\n2. **Add JSON schema validation** - Use Pydantic structured output for concept refinement (like other entities)\n3. **Add recovery logic** - If array received, try to reconstruct object from array elements\n\n## Files affected\n- `src/services/world_quality_service.py` - `_refine_concept()` method (~line 2729)\n\n## Priority\nHIGH - This causes 50%+ of concept generation failures","number":165,"repository":"Aureliolo/story-factory","title":"Concept refinement returns JSON array instead of object","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/165"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOwGQ","repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"Concept refinement returns JSON array instead of object","work Package":"WP1: LLM Output Handling"},{"content":{"body":"## Problem\nThe LLM repeatedly generates the same entity names (e.g., \"The Circuit Lullaby\", \"The Circuit Elegy\") even when the prompt explicitly lists them as forbidden duplicates.\n\n## Evidence from logs\n```\n23:13:33 [WARNING] Concept name 'The Circuit Lullaby' is duplicate, clearing to force retry\n23:13:33 [WARNING] Concept name 'The Circuit Lullaby' is duplicate, clearing to force retry\n23:13:35 [WARNING] Concept name 'The Circuit Lullaby' is duplicate, clearing to force retry\n... (30+ consecutive duplicate warnings for same name)\n```\n\nThis pattern repeats for:\n- \"The Circuit Lullaby\" - 30+ times\n- \"The Circuit Elegy\" - 5+ times  \n- \"The Circuit Weave\" (faction) - 2 times\n- \"The Quantum Quill\" (item) - 1 time\n\n## Impact\n- 3 out of 6 concepts completely failed to generate\n- Wasted 30+ API calls on futile retries\n- Generation time significantly increased\n\n## Root cause analysis\nThe existing names ARE passed in the prompt, but the LLM seems to:\n1. Not understand the prohibition clearly\n2. Have a strong bias toward certain naming patterns (\"The Circuit X\")\n3. Possibly have limited creativity with the given genre constraints\n\n## Proposed solutions\n1. **Stronger prompt language** - Use explicit negative examples: \"DO NOT use these names: X, Y, Z\"\n2. **Add naming diversity hints** - Suggest alternative naming patterns/styles\n3. **Increase temperature** for name generation specifically\n4. **Use few-shot examples** showing unique names\n5. **Hard validation before LLM call** - Reject prompts that might lead to duplicates\n6. **Break the loop earlier** - After 3 consecutive duplicates, try a different naming strategy\n\n## Files affected\n- `src/services/world_quality_service.py` - `_create_concept()`, `_create_faction()` methods\n\n## Priority\nHIGH - Causes 50% of concept generation to fail completely","number":166,"repository":"Aureliolo/story-factory","title":"LLM persistently generates duplicate names despite explicit prohibition","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/166"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOwG0","repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"LLM persistently generates duplicate names despite explicit prohibition","work Package":"WP1: LLM Output Handling"},{"content":{"body":"## Problem\nEntity quality scores consistently plateau at exactly 8.2 across multiple refinement iterations, never improving despite repeated refinement attempts. The quality threshold of 8.5 is rarely met.\n\n## Evidence from logs\n```\nFaction 'The Silicon Veil': iterations 2-10, best score 8.2\nFaction 'The Circuit Syndicate': iterations 2-9, scores stayed at 8.2\nFaction 'The Quantum Quill': iterations 1-10, all scored 8.2\nFaction 'The Binary Veil': iterations 1-10, all scored 8.2\nFaction 'The Circuit Harmonics': iterations 1-10, all scored 8.2\nConcept 'The Circuit Pulse': iterations 1-8, all scored 8.2\n```\n\nPattern observed:\n- 7 out of 7 factions never met the 8.5 threshold\n- All plateaued at exactly 8.2\n- Refinement iterations wasted (10 iterations Ã— 7 factions = 70 API calls)\n\n## Root cause analysis\n1. **Judge model bias** - smollm2:1.7b may have scoring biases\n2. **Ceiling effect** - Judge may not distinguish between \"good\" and \"excellent\"\n3. **Refinement prompts ineffective** - Improvements may not address what judge looks for\n4. **Threshold too high** - 8.5 may be unrealistic for local models\n\n## Proposed solutions\n1. **Calibrate judge model** - Test with reference entities to understand scoring range\n2. **Dynamic threshold** - Lower threshold if consistently not met after N iterations\n3. **Early exit on plateau** - Stop refinement if score unchanged for 3+ iterations\n4. **Different judge model** - Try larger model for judging\n5. **Prompt alignment** - Ensure refinement prompt targets exactly what judge scores\n6. **Add scoring variance** - Inject randomness to avoid exact same scores\n\n## Files affected\n- `src/services/world_quality_service.py` - Refinement loop logic\n- `src/settings.py` - `world_quality_threshold` default (currently 8.5)\n- `src/memory/world_quality.py` - `RefinementConfig`\n\n## Priority\nMEDIUM - Wastes API calls but entities still generate (at lower quality)","number":167,"repository":"Aureliolo/story-factory","title":"Quality scores plateau at 8.2 - refinement iterations ineffective","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/167"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOwHI","repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"Quality scores plateau at 8.2 - refinement iterations ineffective","work Package":"WP2: Refinement Effectiveness"},{"content":{"body":"## Problem\nThe LLM frequently returns empty or invalid responses when creating entities (factions, items, concepts), causing generation failures.\n\n## Evidence from logs\n```\n23:01:26 [ERROR] Faction creation returned empty on iteration 1\n23:03:00 [ERROR] Faction creation returned empty on iteration 1\n23:04:14 [ERROR] Item creation returned empty on iteration 1\n23:06:25 [ERROR] Item creation returned empty on iteration 1\n23:10:07 [ERROR] Item creation returned empty on iteration 4\n23:13:10 [ERROR] Concept creation returned empty on iteration 1\n23:13:11 [ERROR] Concept creation returned empty on iteration 2\n... (30+ concept creation failures)\n```\n\nStatistics:\n- Factions: 2 empty responses\n- Items: 3 empty responses\n- Concepts: 30+ empty responses (after duplicate name rejection)\n\n## Correlation with duplicate names\nEmpty responses often follow duplicate name warnings:\n```\n23:13:33 [WARNING] Concept name 'The Circuit Lullaby' is duplicate\n23:13:33 [ERROR] Concept creation returned empty on iteration 1\n```\n\nThis suggests the LLM may be \"giving up\" when it can't generate a unique name.\n\n## Root cause analysis\n1. **Prompt too constraining** - Too many restrictions (existing names, style requirements)\n2. **Model confusion** - After multiple failed attempts, model may output nothing\n3. **Token limits** - Response may be truncated to nothing\n4. **Temperature too low** - Not enough creativity to generate unique content\n\n## Proposed solutions\n1. **Simplify prompts** on retry - Remove some constraints after initial failures\n2. **Increase temperature progressively** - Start low, increase on failures\n3. **Add fallback generation** - Use simpler prompt if structured fails\n4. **Validate response completeness** - Check for minimum content before accepting\n5. **Add positive examples** - Show what good output looks like\n6. **Retry with different model** - Switch to backup model on repeated failures\n\n## Files affected\n- `src/services/world_quality_service.py` - `_create_concept()`, `_create_faction()`, `_create_item()`\n\n## Priority\nHIGH - Causes complete generation failures, especially for concepts","number":168,"repository":"Aureliolo/story-factory","title":"LLM returns empty responses for entity creation","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/168"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOwHw","repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"LLM returns empty responses for entity creation","work Package":"WP1: LLM Output Handling"},{"content":{"body":"## Problem\nWhen generating relationships, the LLM sometimes references entities that don't exist in the world database.\n\n## Evidence from logs\n```\n23:14:17 [WARNING] Could not find entities for relationship: Dr. Mira Chen -> The Echo Grid\n```\n\n## Root cause analysis\n1. **Entity name mismatch** - LLM may use variant names (e.g., \"Dr. Mira Chen\" vs \"Mira Chen\")\n2. **Entity not yet created** - Relationship references entity that failed to generate\n3. **Hallucinated entities** - LLM invents entity names not in the provided list\n4. **Case sensitivity** - Entity lookup may be case-sensitive\n\n## Proposed solutions\n1. **Fuzzy name matching** - Match entities by similarity, not exact match\n2. **Validate entities before relationship creation** - Only allow relationships between existing entities\n3. **Pass entity IDs** - Use IDs in prompt instead of/alongside names\n4. **Case-insensitive lookup** - Normalize names for comparison\n5. **Add entity existence check in prompt** - Explicitly list all valid entity names\n\n## Files affected\n- `src/services/world_service.py` - Relationship creation logic\n- `src/services/world_quality_service.py` - `_create_relationship()` method\n\n## Priority\nLOW - Only affects relationship accuracy, not generation success","number":169,"repository":"Aureliolo/story-factory","title":"Relationship generation references non-existent entities","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/169"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOwIA","repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"Relationship generation references non-existent entities","work Package":"WP3: Relationship System"},{"content":{"body":"## Problem\n\nWhen generating mini descriptions for entities, the logs show 35 consecutive model selection messages with no context about what's being processed:\n\n```\n2026-01-25 23:14:21 [INFO] Auto-selected smollm2:1.7b for validator\n2026-01-25 23:14:21 [INFO] Auto-selected smollm2:1.7b for validator\n2026-01-25 23:14:22 [INFO] Auto-selected smollm2:1.7b for validator\n... (35 times)\n2026-01-25 23:14:26 [INFO] Generated 35 mini descriptions\n```\n\n## Issues\n\n1. **No entry logging** - Missing \"Starting mini description generation for N entities\"\n2. **No per-entity context** - Model selection logs don't indicate which entity is being processed\n3. **No progress indication** - No way to track progress during generation\n\n## Expected Logging\n\n```\n[INFO] Starting mini description generation for 35 entities\n[DEBUG] Generating mini description 1/35: character 'Dr. Mira Chen'\n[DEBUG] Auto-selected smollm2:1.7b for validator\n[DEBUG] Generating mini description 2/35: location 'The Archive'\n...\n[INFO] Generated 35 mini descriptions in 5.2s\n```\n\n## Location\n\nLikely in `src/ui/pages/world.py` around the mini description generation logic.\n\n## Labels\n\nlogging, quality-of-life","number":171,"repository":"Aureliolo/story-factory","title":"Mini description generation lacks logging context","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/171"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOwIw","repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"Mini description generation lacks logging context","work Package":"WP4: Generation UX"},{"content":{"body":"## Problem\n\nThe icons used on the draggable world map differ from the icons used in the entity list on the left side. The entity list icons are preferred.\n\n## Current State\n\n- **Entity list (left side)**: Has a set of icons for characters, locations, factions, items, concepts\n- **Draggable map (right side)**: Uses different icons for the same entity types\n\n## Expected Behavior\n\nThe draggable world map should use the same icons as the entity list for visual consistency.\n\n## Location\n\nLikely in `src/ui/pages/world.py` or related world map components.\n\n## Labels\n\nui, enhancement","number":172,"repository":"Aureliolo/story-factory","title":"World map icons should match entity list icons","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/172"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOwJI","repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"World map icons should match entity list icons","work Package":"WP5: Entity Browser UI"},{"content":{"body":"## Feature Request\n\nMain protagonists should have a visual distinction - a golden outline/border on their icon to make them stand out from other characters.\n\n## Implementation\n\n- Characters with role \"protagonist\" (or similar high-importance role) should display a golden outline/glow around their icon\n- This should apply in both locations:\n  - **Entity browser** (left side list)\n  - **Draggable world map**\n\n## Visual Example\n\n```\nRegular character:  [icon]\nProtagonist:        [icon with golden border/glow]\n```\n\n## Technical Considerations\n\n- Check the character's `role` field for values like \"protagonist\", \"main character\", etc.\n- Could use CSS border, box-shadow, or SVG filter for the golden effect\n- Consider also highlighting other important roles (antagonist with red outline?)\n\n## Location\n\n- `src/ui/pages/world.py` - entity browser and world map rendering\n\n## Labels\n\nui, enhancement, feature","number":173,"repository":"Aureliolo/story-factory","title":"Add golden outline to protagonist character icons","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/173"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOwJ0","repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"Add golden outline to protagonist character icons","work Package":"WP5: Entity Browser UI"},{"content":{"body":"## Problem\n\nCurrently, relationship count is a static random number in world generation settings. This doesn't account for:\n- Entity importance (protagonists need more relationships than minor items)\n- Entity descriptions and natural connections\n- World coherence and narrative logic\n\n## Proposed Solution\n\nReplace static relationship count with a dynamic, LLM-driven system.\n\n### Phase 1: Entity-by-Entity Analysis\n\nAfter all entities are generated, iterate through each entity:\n\n1. **Proposal LLM (Architect)**: Analyzes the entity + all other entities, proposes:\n   - How many relationships this entity should have\n   - Which specific entities it should connect to\n   - Relationship types and descriptions\n   - Reasoning based on entity descriptions and narrative importance\n\n2. **Refinement LLM (Validator)**: For each proposed relationship:\n   - Validates the relationship makes sense\n   - Scores relationship quality\n   - Refines description if needed\n   - Tracks analytics (like other entity quality metrics)\n\n### Phase 2: Settings for Minimum Relationships\n\nAdd settings to define minimum relationships per entity type:\n\n```python\nrelationship_minimums = {\n    \"character\": {\n        \"protagonist\": 5,      # Main characters need rich connections\n        \"antagonist\": 4,       # Villains need rivals, minions, targets\n        \"supporting\": 2,       # Supporting cast needs some ties\n        \"minor\": 1             # Minor characters need at least one\n    },\n    \"location\": {\n        \"central\": 4,          # HQs, capitals connect to many\n        \"significant\": 2,      # Important places\n        \"minor\": 1             # Background locations\n    },\n    \"faction\": {\n        \"major\": 4,            # Major factions: members, rivals, HQ, goals\n        \"minor\": 2\n    },\n    \"item\": {\n        \"key\": 3,              # Plot-important items: owner, location, purpose\n        \"common\": 1\n    },\n    \"concept\": {\n        \"central_theme\": 4,    # Core themes tie to many entities\n        \"minor_theme\": 2\n    }\n}\n```\n\n### Proposed Flow\n\n```\n1. Generate all entities (existing flow)\n2. For each entity in priority order (protagonists first):\n   a. Gather entity context + all other entities\n   b. LLM proposes relationships based on:\n      - Entity role/importance\n      - Description content\n      - Existing relationships (avoid duplicates)\n      - Minimum requirements from settings\n   c. Each proposed relationship goes through quality refinement loop\n   d. Track analytics: proposals vs accepted, quality scores, refinement iterations\n3. Log summary: \"Generated 47 relationships (avg quality 8.2, 3 rejected)\"\n```\n\n### Benefits\n\n- **Narrative coherence**: Relationships emerge from entity descriptions, not random pairing\n- **Balanced connectivity**: Important entities get more connections naturally\n- **Quality control**: Same refinement/scoring as other entities\n- **Configurable**: Users can tune minimums per entity type\n- **Analytics**: Track relationship generation effectiveness\n\n### Settings Changes\n\nRemove:\n- `relationship_count` (static number)\n\nAdd:\n- `relationship_minimums` (per entity type/role)\n- `relationship_quality_threshold` (minimum score to accept)\n- `max_relationships_per_entity` (prevent over-connection)\n\n## Technical Considerations\n\n- Process entities in importance order (protagonists â†’ supporting â†’ minor)\n- Deduplicate: if Aâ†’B exists, don't create Bâ†’A unless bidirectional\n- Consider relationship types: ally, rival, owns, located_at, embodies, etc.\n- May need to classify entity importance first (protagonist detection)\n\n## Labels\n\nenhancement, world-generation, relationships","number":174,"repository":"Aureliolo/story-factory","title":"Dynamic relationship generation based on entity analysis","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/174"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOwKI","repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"Dynamic relationship generation based on entity analysis","work Package":"WP3: Relationship System"},{"content":{"body":"## Problem\n\nWhen Ollama is struggling (slow responses, high error rate), the system keeps hammering it with requests, potentially making things worse.\n\n## Proposed Solution\n\nImplement a circuit breaker pattern:\n\n1. **Closed state** (normal): Requests go through normally\n2. **Open state** (tripped): After N consecutive failures, stop making requests for a cooldown period\n3. **Half-open state**: After cooldown, try one request to test if service recovered\n\n### Implementation\n\n```python\nclass CircuitBreaker:\n    def __init__(self, failure_threshold=5, cooldown_seconds=30):\n        self.failure_count = 0\n        self.failure_threshold = failure_threshold\n        self.cooldown_seconds = cooldown_seconds\n        self.last_failure_time = None\n        self.state = 'closed'\n    \n    def can_proceed(self) -> bool:\n        if self.state == 'closed':\n            return True\n        if self.state == 'open':\n            if time_since_last_failure > self.cooldown_seconds:\n                self.state = 'half-open'\n                return True\n            return False\n        return True  # half-open: try one request\n    \n    def record_success(self):\n        self.failure_count = 0\n        self.state = 'closed'\n    \n    def record_failure(self):\n        self.failure_count += 1\n        if self.failure_count >= self.failure_threshold:\n            self.state = 'open'\n            self.last_failure_time = now()\n```\n\n### Benefits\n\n- Prevents cascading failures\n- Gives Ollama time to recover\n- Better user feedback (\"Service temporarily unavailable, retrying in 30s\")\n\n## Labels\n\nreliability, enhancement","number":175,"repository":"Aureliolo/story-factory","title":"Circuit breaker pattern for LLM calls","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/175"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOwKk","repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"Circuit breaker pattern for LLM calls","work Package":"WP1: LLM Output Handling"},{"content":{"body":"## Problem\n\nCurrent duplicate detection uses string matching, which misses semantic duplicates:\n- \"Shadow Council\" vs \"Council of Shadows\"\n- \"The Dark Forest\" vs \"Forest of Darkness\"\n- \"King's Guard\" vs \"Royal Guardsmen\"\n\nThis causes the LLM to generate variations that are conceptually identical.\n\n## Proposed Solution\n\nUse embedding-based similarity detection:\n\n1. **Generate embeddings** for all existing entity names/descriptions\n2. **Compare new entity** embedding against existing ones\n3. **Reject if similarity > threshold** (e.g., 0.85 cosine similarity)\n\n### Implementation Options\n\n**Option A: Use Ollama embeddings**\n```python\ndef get_embedding(text: str) -> list[float]:\n    response = ollama.embeddings(model='nomic-embed-text', prompt=text)\n    return response['embedding']\n\ndef is_semantic_duplicate(new_name: str, existing_names: list[str], threshold=0.85) -> bool:\n    new_embedding = get_embedding(new_name)\n    for existing in existing_names:\n        existing_embedding = get_embedding(existing)\n        similarity = cosine_similarity(new_embedding, existing_embedding)\n        if similarity > threshold:\n            return True\n    return False\n```\n\n**Option B: Use lightweight sentence-transformers**\n- Faster, runs locally\n- Models like 'all-MiniLM-L6-v2' are small and effective\n\n### Settings\n\n```python\nsemantic_duplicate_detection: bool = True\nsemantic_similarity_threshold: float = 0.85\nembedding_model: str = 'nomic-embed-text'\n```\n\n### Benefits\n\n- Catches conceptually identical entities\n- Reduces wasted generation attempts\n- Improves world diversity\n\n## Labels\n\nenhancement, world-generation, quality","number":176,"repository":"Aureliolo/story-factory","title":"Semantic duplicate detection using embeddings","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/176"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOwLI","repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"Semantic duplicate detection using embeddings","work Package":"WP1: LLM Output Handling"},{"content":{"body":"## Problem\n\nCurrently, temperature is static during entity generation. This means:\n- Early iterations might not be creative enough\n- Later iterations might still be too random when we need precision\n\n## Proposed Solution\n\nAdjust temperature dynamically based on refinement iteration:\n\n```python\ndef get_temperature_for_iteration(iteration: int, max_iterations: int) -> float:\n    # Start creative, become more focused\n    # Iteration 1: 0.9 (creative)\n    # Iteration 5: 0.7 (balanced)\n    # Iteration 10: 0.5 (focused)\n    \n    start_temp = 0.9\n    end_temp = 0.5\n    progress = iteration / max_iterations\n    return start_temp - (progress * (start_temp - end_temp))\n```\n\n### Rationale\n\n- **Early iterations (high temp)**: Explore creative possibilities\n- **Middle iterations (medium temp)**: Refine promising directions\n- **Late iterations (low temp)**: Make precise improvements\n\n### Settings\n\n```python\nrefinement_temp_start: float = 0.9\nrefinement_temp_end: float = 0.5\nrefinement_temp_curve: str = 'linear'  # or 'exponential'\n```\n\n### Benefits\n\n- Better exploration in early iterations\n- More predictable refinement in later iterations\n- Potentially faster convergence to quality threshold\n\n## Labels\n\nenhancement, world-generation, quality","number":177,"repository":"Aureliolo/story-factory","title":"Dynamic temperature adjustment during refinement","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/177"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOwLU","repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"Dynamic temperature adjustment during refinement","work Package":"WP2: Refinement Effectiveness"},{"content":{"body":"## Problem\n\nGenerated entities may contradict each other:\n- Character A is \"the only survivor\" but Character B also \"survived the incident\"\n- Location X is \"abandoned for centuries\" but Faction Y \"has operated there for decades\"\n- Item Z \"was destroyed\" but Character C \"carries it always\"\n\n## Proposed Solution\n\nPost-generation validation pass that checks for contradictions:\n\n### Phase 1: Extract Claims\n\nFor each entity, extract factual claims:\n```python\nclaims = extract_claims(entity)\n# Returns: [\n#   {'subject': 'Character A', 'claim': 'only survivor of incident X'},\n#   {'subject': 'Location Y', 'claim': 'abandoned for 200 years'},\n# ]\n```\n\n### Phase 2: Cross-Reference\n\nCompare claims across entities using LLM:\n```\nPrompt: \"Do these two claims contradict each other?\nClaim 1: {claim_a}\nClaim 2: {claim_b}\nAnswer: YES/NO with explanation\"\n```\n\n### Phase 3: Report & Resolve\n\n- Flag contradictions with severity (critical/minor)\n- Offer resolution options:\n  - Regenerate one entity\n  - Manually edit\n  - Accept with warning\n\n### UI Integration\n\n- \"Validate World\" button\n- Contradiction report with links to affected entities\n- Batch resolution workflow\n\n## Benefits\n\n- Catches logical inconsistencies\n- Improves world coherence\n- Helps users spot issues before story writing\n\n## Labels\n\nenhancement, quality, validation","number":178,"repository":"Aureliolo/story-factory","title":"Entity consistency validation - detect contradictions","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/178"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOwLs","repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"Entity consistency validation - detect contradictions","work Package":"WP6: World Health & Validation"},{"content":{"body":"## Problem\n\nCharacter generation doesn't consider narrative arc structures, leading to flat or incomplete character designs.\n\n## Proposed Solution\n\nProvide arc templates that guide character generation:\n\n### Protagonist Arc Templates\n\n```python\narc_templates = {\n    'hero_journey': {\n        'stages': ['ordinary_world', 'call_to_adventure', 'refusal', \n                   'meeting_mentor', 'crossing_threshold', 'tests_allies_enemies',\n                   'approach', 'ordeal', 'reward', 'road_back', 'resurrection', 'return'],\n        'required_traits': ['flaw', 'desire', 'need', 'ghost'],\n    },\n    'redemption': {\n        'stages': ['fall', 'rock_bottom', 'catalyst', 'struggle', 'redemption'],\n        'required_traits': ['past_sin', 'guilt', 'opportunity'],\n    },\n    'coming_of_age': {\n        'stages': ['innocence', 'challenge', 'growth', 'maturity'],\n        'required_traits': ['naivety', 'potential', 'mentor_figure'],\n    },\n    'tragedy': {\n        'stages': ['greatness', 'hubris', 'downfall', 'recognition', 'catastrophe'],\n        'required_traits': ['fatal_flaw', 'blindness', 'noble_qualities'],\n    }\n}\n```\n\n### Antagonist Templates\n\n```python\nantagonist_templates = {\n    'mirror': 'Reflects protagonist, same goal different methods',\n    'force_of_nature': 'Unstoppable, impersonal threat',\n    'fallen_hero': 'Was good, became corrupted',\n    'true_believer': 'Genuinely believes they are right',\n    'mastermind': 'Always three steps ahead',\n}\n```\n\n### Integration\n\n- When generating protagonist, prompt includes arc template guidance\n- Character description must address required traits\n- Relationships should reflect arc (mentor, ally, rival)\n\n## Benefits\n\n- More narratively satisfying characters\n- Built-in character development potential\n- Better protagonist-antagonist dynamics\n\n## Labels\n\nenhancement, world-generation, characters","number":179,"repository":"Aureliolo/story-factory","title":"Character arc templates for protagonist/antagonist generation","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/179"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOwMM","repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"Character arc templates for protagonist/antagonist generation","work Package":"WP7: Templates & Content"},{"content":{"body":"## Problem\n\nOnce world generation starts, there's no way to stop it. Users are stuck waiting even if:\n- They realize they used wrong settings\n- It's taking too long\n- They need to do something else\n\n## Proposed Solution\n\nAdd a cancel button that gracefully stops generation:\n\n### UI\n\n```\n[Building World Structure...]  [Cancel]\n\nAfter clicking:\n[Cancelling... finishing current entity]\n```\n\n### Implementation\n\n1. **Cancellation token** passed to generation methods\n2. **Check token** between entity generations\n3. **Graceful stop** - finish current entity, don't start new ones\n4. **Keep completed work** - save what was generated so far\n\n```python\nclass CancellationToken:\n    def __init__(self):\n        self._cancelled = threading.Event()\n    \n    def cancel(self):\n        self._cancelled.set()\n    \n    def is_cancelled(self) -> bool:\n        return self._cancelled.is_set()\n\n# In generation loop:\nfor i in range(entity_count):\n    if cancellation_token.is_cancelled():\n        logger.info('Generation cancelled by user after %d entities', i)\n        break\n    generate_entity(...)\n```\n\n### UX Considerations\n\n- Confirmation dialog: \"Cancel generation? 5/10 characters will be kept.\"\n- Show what was completed after cancellation\n- Allow resuming from where it stopped\n\n## Benefits\n\n- User control over long operations\n- No lost work (completed entities saved)\n- Better UX for iterative worldbuilding\n\n## Labels\n\nux, enhancement, high-priority","number":180,"repository":"Aureliolo/story-factory","title":"Cancel button for long-running generations","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/180"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOwMg","repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"Cancel button for long-running generations","work Package":"WP4: Generation UX"},{"content":{"body":"## Problem\n\nIf one entity is low quality, users must either:\n- Manually edit it\n- Regenerate the entire world\n- Live with it\n\nThere's no way to just regenerate one entity.\n\n## Proposed Solution\n\nAdd a \"Regenerate\" button to each entity in the browser:\n\n### UI\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ Dr. Mira Chen                   â”‚\nâ”‚ Character â€¢ Protagonist         â”‚\nâ”‚ Score: 6.8                      â”‚\nâ”‚                                 â”‚\nâ”‚ [Edit] [Regenerate â†»] [Delete]  â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n### Regeneration Options\n\n1. **Full regenerate** - Create entirely new entity of same type\n2. **Refine existing** - Use current as base, improve quality\n3. **Regenerate with guidance** - User provides hints for new version\n\n### Implementation\n\n```python\ndef regenerate_entity(entity_id: str, mode: str = 'full', guidance: str = None):\n    entity = get_entity(entity_id)\n    \n    if mode == 'full':\n        # Generate new entity, replace old\n        new_entity = generate_entity(entity.type, exclude_names=[entity.name])\n    elif mode == 'refine':\n        # Use existing as starting point\n        new_entity = refine_entity(entity, quality_threshold=8.5)\n    elif mode == 'guided':\n        # Include user guidance in prompt\n        new_entity = generate_entity(entity.type, guidance=guidance)\n    \n    # Preserve relationships\n    transfer_relationships(entity_id, new_entity.id)\n    delete_entity(entity_id)\n```\n\n### Relationship Handling\n\n- Option to preserve existing relationships\n- Option to regenerate relationships too\n- Warning if entity has many connections\n\n## Benefits\n\n- Fine-grained control over world quality\n- No need to redo entire generation\n- Iterative improvement workflow\n\n## Labels\n\nux, enhancement, high-priority","number":181,"repository":"Aureliolo/story-factory","title":"Regenerate single entity button","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/181"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOwOU","repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"Regenerate single entity button","work Package":"WP5: Entity Browser UI"},{"content":{"body":"## Problem\n\nWith many entities (30+), finding a specific one requires scrolling through the entire list.\n\n## Proposed Solution\n\nAdd search and filter capabilities to the entity browser:\n\n### Search Box\n\n```\nğŸ” [Search entities...                    ]\n   [x] Names  [x] Descriptions  [ ] Tags\n```\n\n- Real-time filtering as user types\n- Search in names, descriptions, or both\n- Highlight matching text\n\n### Filter Options\n\n```\nType:    [All â–¾]  Character | Location | Faction | Item | Concept\nRole:    [All â–¾]  Protagonist | Antagonist | Supporting | Minor\nQuality: [All â–¾]  â˜…â˜…â˜… (8+) | â˜…â˜… (6-8) | â˜… (<6)\nStatus:  [All â–¾]  Has relationships | Orphaned | Needs review\n```\n\n### Sort Options\n\n```\nSort by: [Name â–¾]  Name | Type | Quality | Date created | Relationship count\n```\n\n### Keyboard Shortcuts\n\n- `Ctrl+F` / `Cmd+F` - Focus search\n- `Esc` - Clear search\n- `â†‘â†“` - Navigate results\n\n## Benefits\n\n- Quick entity lookup\n- Find low-quality entities easily\n- Better organization for large worlds\n\n## Labels\n\nux, enhancement","number":182,"repository":"Aureliolo/story-factory","title":"Search and filter in entity browser","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/182"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOwOo","repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"Search and filter in entity browser","work Package":"WP5: Entity Browser UI"},{"content":{"body":"## Problem\n\nStarting a new world from scratch requires users to:\n- Configure all generation settings\n- Hope the LLM understands their genre\n- Manually adjust for genre conventions\n\n## Proposed Solution\n\nProvide genre-specific world templates:\n\n### Template Structure\n\n```python\nworld_templates = {\n    'high_fantasy': {\n        'description': 'Epic fantasy with magic, kingdoms, and quests',\n        'entity_hints': {\n            'character_roles': ['chosen_one', 'wise_mentor', 'dark_lord', 'loyal_companion'],\n            'location_types': ['ancient_kingdom', 'enchanted_forest', 'dark_fortress', 'sacred_temple'],\n            'faction_types': ['royal_house', 'mage_guild', 'thieves_guild', 'ancient_order'],\n            'item_types': ['legendary_weapon', 'magical_artifact', 'ancient_tome', 'royal_regalia'],\n            'concept_types': ['prophecy', 'ancient_magic', 'divine_blessing', 'corruption'],\n        },\n        'relationship_patterns': ['mentor_student', 'rival_kingdoms', 'forbidden_love'],\n        'naming_style': 'tolkien-esque',\n        'recommended_counts': {'characters': 12, 'locations': 8, 'factions': 5},\n    },\n    'cyberpunk': {\n        'description': 'Dystopian future with megacorps, hackers, and augmentation',\n        'entity_hints': {\n            'character_roles': ['street_samurai', 'netrunner', 'corporate_exec', 'fixer'],\n            'location_types': ['megacity', 'corporate_tower', 'underground_club', 'black_market'],\n            'faction_types': ['megacorporation', 'hacker_collective', 'street_gang', 'resistance'],\n        },\n        ...\n    },\n    'urban_fantasy': {...},\n    'space_opera': {...},\n    'post_apocalyptic': {...},\n    'noir_detective': {...},\n    'historical_fiction': {...},\n}\n```\n\n### UI Integration\n\n```\nNew World\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€\nChoose a template:\n\n  âš”ï¸  High Fantasy     Epic kingdoms, magic, prophecies\n  ğŸŒ†  Cyberpunk        Megacorps, hackers, neon dystopia\n  ğŸ§›  Urban Fantasy    Magic hidden in modern world\n  ğŸš€  Space Opera      Galactic empires, alien races\n  â˜¢ï¸  Post-Apocalyptic Survival in ruined civilization\n  ğŸ”  Noir Detective   Gritty crime, moral ambiguity\n  ğŸ“œ  Historical       Based on real historical periods\n  ğŸ“  Blank Canvas     Start from scratch\n```\n\n### Template Customization\n\n- Use template as starting point\n- Modify any settings before generation\n- Save custom templates\n\n## Benefits\n\n- Faster world creation\n- Genre-appropriate entities\n- Consistent world feel\n- Great for new users\n\n## Labels\n\nenhancement, ux, feature","number":183,"repository":"Aureliolo/story-factory","title":"World templates - presets for Fantasy, Sci-Fi, Modern, etc.","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/183"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOwO0","repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"World templates - presets for Fantasy, Sci-Fi, Modern, etc.","work Package":"WP7: Templates & Content"},{"content":{"body":"## Problem\n\nWhen editing entities, there's no way to:\n- See what changed over time\n- Revert to a previous version\n- Compare before/after refinement\n\n## Proposed Solution\n\nTrack entity versions in the database:\n\n### Schema Extension\n\n```sql\nCREATE TABLE entity_versions (\n    id TEXT PRIMARY KEY,\n    entity_id TEXT NOT NULL,\n    version_number INTEGER NOT NULL,\n    data_json TEXT NOT NULL,  -- Full entity snapshot\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    change_type TEXT,  -- 'created', 'refined', 'edited', 'regenerated'\n    change_reason TEXT,  -- 'quality_refinement', 'user_edit', etc.\n    quality_score REAL,\n    FOREIGN KEY (entity_id) REFERENCES entities(id)\n);\n```\n\n### UI Features\n\n1. **Version history panel**\n```\nDr. Mira Chen - History\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nv3 (current) - User edit - Jan 25, 2026\nv2 - Quality refinement (7.2 â†’ 8.4) - Jan 25, 2026\nv1 - Initial generation - Jan 25, 2026\n\n[Compare v2 â†” v3] [Revert to v2]\n```\n\n2. **Diff view**\n```\nDescription:\n- A brilliant but reclusive scientist...\n+ A brilliant but haunted scientist who lost her family...\n```\n\n3. **Revert confirmation**\n```\nRevert to version 2?\nThis will restore the entity to its state after quality refinement.\nCurrent version will be saved as v4.\n[Cancel] [Revert]\n```\n\n### Retention Policy\n\n- Keep last N versions (configurable, default 10)\n- Always keep initial and current\n- Option to pin important versions\n\n## Benefits\n\n- Undo mistakes\n- See refinement improvements\n- Compare generation approaches\n- Audit trail for changes\n\n## Labels\n\nenhancement, feature","number":184,"repository":"Aureliolo/story-factory","title":"Entity versioning - track changes and revert","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/184"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOwPM","repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"Entity versioning - track changes and revert","work Package":"WP9: Data Integrity"},{"content":{"body":"## Problem\n\nDuring world generation, users have no visibility into what is happening or how long it will take.\n\n## Proposed Solution\n\nAdd detailed progress tracking with:\n\n- Current operation (e.g., Generating character 5/10)\n- Entity name being worked on\n- Refinement iteration and current score\n- Completion status per entity type\n- Elapsed time and estimated remaining time\n\n## Implementation\n\n- Progress callback passed to generation methods\n- Real-time updates via WebSocket/SSE to UI\n- ETA calculation based on average time per entity type\n\n## Benefits\n\n- Users know the system is working\n- Can estimate if they have time to wait\n- Identifies slow entity types\n\n## Labels\n\nux, enhancement, high-priority","number":185,"repository":"Aureliolo/story-factory","title":"Progress bar with estimates during world generation","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/185"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOwPU","repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"Progress bar with estimates during world generation","work Package":"WP4: Generation UX"},{"content":{"body":"## Problem\n\nStories have temporal elements that are hard to visualize:\n- When did events happen?\n- Character ages and lifespans\n- Faction rise and fall\n- Item creation and destruction\n\n## Proposed Solution\n\nAdd a timeline visualization:\n\n### Features\n\n1. **Horizontal timeline** with zoom levels (years, decades, centuries)\n2. **Entity markers** showing when entities existed/were active\n3. **Event markers** for key story moments\n4. **Relationship lines** showing when relationships formed/ended\n\n### Timeline Elements\n\n- **Characters**: Birth â†’ key events â†’ present/death\n- **Factions**: Founded â†’ major events â†’ current/dissolved\n- **Locations**: Established â†’ ownership changes â†’ current\n- **Items**: Created â†’ changed hands â†’ current location\n- **Events**: Plot points, battles, discoveries\n\n### UI Mockup\n\n```\nTimeline                                    [Zoom: Decades â–¾]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n    1900        1950        2000        2050\n      â”‚           â”‚           â”‚           â”‚\n      â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â— Dr. Mira Chen\n                  â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â— The Archive\n      â–² Founded   â–² Incident  â–² Story begins\n```\n\n### Data Model\n\n```python\nclass TimelineEvent:\n    entity_id: str\n    event_type: str  # 'birth', 'founded', 'battle', 'discovery'\n    date: str  # Flexible format\n    description: str\n```\n\n## Benefits\n\n- Visualize story chronology\n- Spot timeline inconsistencies\n- Plan story pacing\n- Understand entity histories\n\n## Labels\n\nenhancement, feature, visualization","number":186,"repository":"Aureliolo/story-factory","title":"Timeline view for events and entity history","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/186"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOwPw","repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"Timeline view for events and entity history","work Package":"WP8: Visualizations"},{"content":{"body":"## Problem\n\nStories need conflict and tension, but it is hard to see:\n- Who opposes whom?\n- What are the power dynamics?\n- Where are the alliances and rivalries?\n\n## Proposed Solution\n\nAdd a conflict/tension visualization:\n\n### Features\n\n1. **Force-directed graph** showing entities as nodes\n2. **Edge colors** indicating relationship type:\n   - Green: Alliance/friendship\n   - Red: Rivalry/conflict\n   - Yellow: Tension/distrust\n   - Blue: Neutral/professional\n3. **Edge thickness** showing relationship intensity\n4. **Clustering** by faction affiliation\n\n### Tension Metrics\n\n```python\ntension_analysis = {\n    'highest_tension': [('Dr. Chen', 'The Corporation', 0.95)],\n    'strongest_alliance': [('Hero', 'Mentor', 0.90)],\n    'isolated_entities': ['The Artifact'],  # No strong relationships\n    'faction_tensions': [('Rebels', 'Empire', 0.85)],\n    'love_triangles': [...],\n    'power_imbalances': [...],\n}\n```\n\n### UI Features\n\n- Toggle relationship types on/off\n- Highlight specific entity's connections\n- Show relationship details on hover\n- Filter by tension threshold\n\n### Automatic Analysis\n\nLLM analyzes relationships and suggests:\n- Missing conflicts (story might be too peaceful)\n- Unbalanced power dynamics\n- Potential plot points from tensions\n\n## Benefits\n\n- Visual story conflict structure\n- Identify weak/missing tensions\n- Balance protagonist challenges\n- Plan dramatic confrontations\n\n## Labels\n\nenhancement, feature, visualization","number":187,"repository":"Aureliolo/story-factory","title":"Conflict and tension mapping visualization","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/187"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOwQI","repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"Conflict and tension mapping visualization","work Package":"WP8: Visualizations"},{"content":{"body":"## Problem\n\nNo overview of world quality and completeness:\n- How many entities of each type?\n- What is the average quality?\n- Are there orphaned entities?\n- Is relationship density appropriate?\n\n## Proposed Solution\n\nAdd a world health dashboard:\n\n### Statistics Panel\n\n```\nWorld Health: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 78%\n\nEntity Counts          Quality Distribution\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nCharacters: 10         â˜…â˜…â˜…â˜… (9+):  â–ˆâ–ˆâ–ˆ 12%\nLocations:   5         â˜…â˜…â˜…  (8-9): â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 45%\nFactions:    7         â˜…â˜…   (7-8): â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 33%\nItems:      10         â˜…    (<7):  â–ˆâ–ˆ 10%\nConcepts:    3\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nTotal:      35         Avg Quality: 8.1\n```\n\n### Health Checks\n\n```\nâœ“ All entity types present\nâœ“ Relationship density: 1.4 per entity (good)\nâš  2 orphaned entities (no relationships)\nâš  3 entities below quality threshold\nâœ— No antagonist character detected\nâœ— Protagonist has only 2 relationships (recommend 5+)\n```\n\n### Recommendations\n\n```\nSuggested Actions:\n1. Add relationships to orphaned entities\n2. Regenerate low-quality entities\n3. Consider adding an antagonist\n4. Strengthen protagonist connections\n```\n\n### Metrics Tracked\n\n- Entity counts by type\n- Quality score distribution\n- Relationship density (edges/nodes)\n- Orphan count\n- Role coverage (protagonist, antagonist, mentor, etc.)\n- Generation success rate\n\n## Benefits\n\n- Quick world quality assessment\n- Identify gaps and issues\n- Guide improvement efforts\n- Track progress over time\n\n## Labels\n\nenhancement, analytics, ux","number":188,"repository":"Aureliolo/story-factory","title":"World health dashboard - statistics and diagnostics","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/188"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOwQo","repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"World health dashboard - statistics and diagnostics","work Package":"WP6: World Health & Validation"},{"content":{"body":"## Problem\n\nNo visibility into generation costs:\n- How many tokens were used?\n- How long did each entity type take?\n- Which model is more efficient?\n\n## Proposed Solution\n\nTrack and display generation costs:\n\n### Metrics to Track\n\n```python\ngeneration_metrics = {\n    'total_tokens': 45230,\n    'total_time_seconds': 342,\n    'by_entity_type': {\n        'character': {'tokens': 12500, 'time': 95, 'count': 10, 'avg_iterations': 4.2},\n        'location': {'tokens': 6200, 'time': 48, 'count': 5, 'avg_iterations': 3.1},\n        ...\n    },\n    'by_model': {\n        'qwen3:30b': {'tokens': 38000, 'time': 290, 'quality_avg': 8.2},\n        'smollm2:1.7b': {'tokens': 7230, 'time': 52, 'quality_avg': 7.8},\n    },\n    'refinement_overhead': {\n        'total_iterations': 156,\n        'wasted_iterations': 23,  # Score decreased\n        'early_stops': 8,\n    }\n}\n```\n\n### UI Display\n\n```\nGeneration Summary\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nTotal time: 5m 42s\nTotal tokens: ~45,000\n\nBy Entity Type:\n  Characters: 95s (12.5k tokens) - 4.2 avg iterations\n  Locations:  48s (6.2k tokens)  - 3.1 avg iterations\n  Factions:   62s (8.1k tokens)  - 5.0 avg iterations\n  ...\n\nModel Efficiency:\n  qwen3:30b:   8.2 avg quality, 290s\n  smollm2:1.7b: 7.8 avg quality, 52s (validator)\n```\n\n### Historical Tracking\n\n- Store metrics per generation run\n- Compare across projects\n- Identify trends over time\n\n## Benefits\n\n- Understand generation costs\n- Optimize model selection\n- Identify inefficiencies\n- Budget time for generations\n\n## Labels\n\nanalytics, enhancement","number":189,"repository":"Aureliolo/story-factory","title":"Generation cost tracking - tokens, time, model comparison","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/189"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOwSA","repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"Generation cost tracking - tokens, time, model comparison","work Package":"WP8: Visualizations"},{"content":{"body":"## Problem\n\nEntities with no relationships are disconnected from the world:\n- They may never appear in the story\n- They waste generation effort\n- They indicate incomplete worldbuilding\n\n## Proposed Solution\n\nDetect and warn about orphaned entities:\n\n### Detection\n\n```python\ndef find_orphans(world_db) -> list[Entity]:\n    orphans = []\n    for entity in world_db.get_all_entities():\n        relationships = world_db.get_relationships(entity.id)\n        if len(relationships) == 0:\n            orphans.append(entity)\n    return orphans\n```\n\n### UI Indicators\n\n1. **Entity browser** - Badge/icon on orphaned entities\n```\n  ğŸ‘¤ Dr. Mira Chen (5 relationships)\n  ğŸ‘¤ John Smith âš ï¸ (orphaned)\n```\n\n2. **World health dashboard** - Orphan count and list\n\n3. **Post-generation warning**\n```\nâš ï¸ 2 entities have no relationships:\n  - John Smith (character)\n  - Old Warehouse (location)\n  \n[Add Relationships] [Ignore]\n```\n\n### Resolution Options\n\n- **Auto-generate relationships** for orphans\n- **Merge** orphan into similar entity\n- **Delete** if truly unnecessary\n- **Ignore** with acknowledgment\n\n### Settings\n\n```python\norphan_detection_enabled: bool = True\nwarn_on_orphans: bool = True\nauto_fix_orphans: bool = False\n```\n\n## Benefits\n\n- No forgotten entities\n- More connected worlds\n- Better story integration\n- Cleaner worldbuilding\n\n## Labels\n\nvalidation, enhancement, quality","number":190,"repository":"Aureliolo/story-factory","title":"Orphan entity detection and warnings","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/190"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOwSY","repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"Orphan entity detection and warnings","work Package":"WP3: Relationship System"},{"content":{"body":"## Problem\n\nCircular relationships can create logical inconsistencies:\n- A owns B, B owns C, C owns A (who really owns what?)\n- A reports to B, B reports to C, C reports to A (broken hierarchy)\n- A is parent of B, B is parent of A (impossible)\n\n## Proposed Solution\n\nDetect and warn about circular relationships:\n\n### Detection Algorithm\n\n```python\ndef find_circular_relationships(world_db, relationship_type: str) -> list[list[str]]:\n    \"\"\"Find cycles in directed relationships of a specific type.\"\"\"\n    graph = build_directed_graph(world_db, relationship_type)\n    cycles = []\n    \n    for node in graph.nodes:\n        # DFS to find cycles starting from this node\n        cycle = find_cycle_from(graph, node)\n        if cycle:\n            cycles.append(cycle)\n    \n    return cycles\n```\n\n### Relationship Types to Check\n\n- **Ownership**: owns, possesses, controls\n- **Hierarchy**: reports_to, serves, commands\n- **Lineage**: parent_of, child_of, ancestor_of\n- **Location**: located_in, contains\n\n### UI Warning\n\n```\nâš ï¸ Circular relationship detected:\n\n  The Archive â†’ contains â†’ The Vault â†’ contains â†’ \n  The Archive (circular!)\n\nThis may be intentional (e.g., recursive structure) or an error.\n\n[Ignore] [Fix: Remove one relationship]\n```\n\n### Settings\n\n```python\ncircular_detection_enabled: bool = True\ncircular_relationship_types: list[str] = ['owns', 'reports_to', 'parent_of', 'located_in']\nallow_self_references: bool = False\n```\n\n## Benefits\n\n- Catch logical impossibilities\n- Cleaner relationship graphs\n- Prevent story contradictions\n\n## Labels\n\nvalidation, enhancement","number":191,"repository":"Aureliolo/story-factory","title":"Circular relationship detection","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/191"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOwSs","repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"Circular relationship detection","work Package":"WP3: Relationship System"},{"content":{"body":"## Problem\n\nBackups may become corrupted or incomplete:\n- Disk errors during write\n- Interrupted backup process\n- Version mismatches\n- Missing referenced files\n\nRestoring from a bad backup could cause data loss.\n\n## Proposed Solution\n\nVerify backup integrity before trusting it:\n\n### Verification Checks\n\n1. **File completeness**\n   - All expected files present\n   - File sizes non-zero\n   - JSON/SQLite files parseable\n\n2. **Data integrity**\n   - Checksum verification (SHA-256)\n   - Foreign key consistency\n   - Required fields present\n\n3. **Version compatibility**\n   - Backup version matches restore target\n   - Schema migrations available if needed\n\n### Implementation\n\n```python\nclass BackupVerifier:\n    def verify(self, backup_path: str) -> BackupVerificationResult:\n        result = BackupVerificationResult()\n        \n        # Check manifest\n        manifest = self.read_manifest(backup_path)\n        result.add_check('manifest_valid', manifest is not None)\n        \n        # Verify checksums\n        for file_info in manifest.files:\n            actual_checksum = self.compute_checksum(file_info.path)\n            result.add_check(\n                f'checksum_{file_info.name}',\n                actual_checksum == file_info.expected_checksum\n            )\n        \n        # Verify database integrity\n        db_valid = self.verify_database(backup_path / 'world.db')\n        result.add_check('database_integrity', db_valid)\n        \n        # Check version compatibility\n        compatible = self.check_version_compatibility(manifest.version)\n        result.add_check('version_compatible', compatible)\n        \n        return result\n```\n\n### UI Integration\n\n```\nRestore from Backup\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nSelected: backup_2026-01-25_123456.zip\n\nVerification: âœ“ Passed\n  âœ“ Manifest valid\n  âœ“ All files present (12/12)\n  âœ“ Checksums match\n  âœ“ Database integrity OK\n  âœ“ Version compatible\n\n[Cancel] [Restore]\n```\n\n### On Failure\n\n```\nâš ï¸ Backup verification failed:\n  âœ— Checksum mismatch: world.db\n  âœ— Missing file: project.json\n  \nThis backup may be corrupted. Restore anyway?\n[Cancel] [Restore Anyway (risky)]\n```\n\n## Benefits\n\n- Prevent restoring corrupted data\n- Confidence in backup reliability\n- Early detection of backup issues\n\n## Labels\n\nreliability, safety, enhancement","number":192,"repository":"Aureliolo/story-factory","title":"Backup integrity verification","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/192"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOwTA","repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"Backup integrity verification","work Package":"WP9: Data Integrity"},{"content":{"body":"## Problem\n\nGenerated content may not match the intended tone:\n- Too dark for a children's story\n- Too lighthearted for a thriller\n- Inappropriate content for the target audience\n- Inconsistent tone across entities\n\n## Proposed Solution\n\nAdd content guidelines that are enforced during generation:\n\n### Guideline Profiles\n\n```python\ncontent_profiles = {\n    'all_ages': {\n        'violence': 'minimal',  # No graphic violence\n        'language': 'clean',    # No profanity\n        'themes': 'uplifting',  # Positive resolution\n        'romance': 'none',      # No romantic content\n    },\n    'young_adult': {\n        'violence': 'moderate',  # Action OK, no gore\n        'language': 'mild',      # Mild language OK\n        'themes': 'challenging', # Complex themes OK\n        'romance': 'mild',       # Implied OK, no explicit\n    },\n    'adult': {\n        'violence': 'graphic',   # No restrictions\n        'language': 'unrestricted',\n        'themes': 'unrestricted',\n        'romance': 'explicit',\n    },\n    'custom': {\n        # User-defined restrictions\n    }\n}\n```\n\n### Enforcement\n\n1. **Prompt injection**: Add guidelines to generation prompts\n2. **Post-generation check**: LLM reviews content against guidelines\n3. **Flag violations**: Warn user, offer to regenerate\n\n### UI Integration\n\n```\nContent Guidelines\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nProfile: [Young Adult â–¾]\n\nCustomizations:\n  Violence:  [Moderate â–¾]\n  Language:  [Mild â–¾]\n  Themes:    [Challenging â–¾]\n  Romance:   [Mild â–¾]\n\nâ˜‘ Enforce during generation\nâ˜‘ Warn on violations\nâ˜ Auto-reject violations\n```\n\n### Violation Handling\n\n```\nâš ï¸ Content guideline violation detected:\n\nEntity: \"The Dark Ritual\" (concept)\nIssue: Contains graphic violence description\nGuideline: Violence set to 'moderate'\n\n[Edit Manually] [Regenerate] [Allow Exception]\n```\n\n## Benefits\n\n- Consistent story tone\n- Appropriate for target audience\n- User control over content\n- Prevent unwanted surprises\n\n## Labels\n\nsafety, enhancement, content","number":193,"repository":"Aureliolo/story-factory","title":"Content guidelines enforcement for generated content","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/193"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOwTY","repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"Content guidelines enforcement for generated content","work Package":"WP7: Templates & Content"},{"content":{"body":"## Feature Description\n[XLLamaCPP](https://github.com/xorbitsai/xllamacpp) is a Cython build of LLamaCPP that supports CUDA, Vulkan, and MPS. It may be helpful to offer this inference engine as an alternative to Ollama.\n\n## Problem/Motivation\n- Provides a full stack application without relying on the externally-managed and [brittle](https://github.com/fszontagh/sd.cpp.gui.wx/issues/40#issuecomment-2740446984) Ollama\n- Supports structured outputs (solves #165)\n- Cross-platform [VRAM awareness](https://github.com/xorbitsai/xllamacpp/blob/1062afba12500a9b78ff3c0911df3116e8d5bae4/tests/test_memory.py#L72) rather than [relying](https://github.com/Aureliolo/story-factory/blob/212557ed03cb0c29b19e1f2fd4f73cc92f8bf9e7/src/settings.py#L1280) on `nvidia-smi`\n- Full control when running multiple models, e.g. detect available VRAM and swap models if there are insufficient available resources\n\n## Proposed Solution\nSample inference code is available [here](https://github.com/xorbitsai/xllamacpp/blob/1062afba12500a9b78ff3c0911df3116e8d5bae4/tests/test_server.py). The simplest option may be to start a server instance and then use the OpenAI client for inference (code examples: [backend](https://github.com/xorbitsai/xllamacpp/blob/1062afba12500a9b78ff3c0911df3116e8d5bae4/README.md#openai-api-compatible-http-server), [frontend](https://github.com/zauberzeug/nicegui/blob/4e3af342a1ff5d2633fb1ab053b250777c7f6311/examples/chat_with_ai/main.py#L10)).\n\n## Notes\n- XLLamaCPP does not provide zero-day model support, usually lagging by a few weeks\n- [Device-SMI](https://github.com/ModelCloud/Device-SMI) may be a suitable alternative to XLLamaCPP for VRAM awareness","number":194,"repository":"Aureliolo/story-factory","title":"[FEATURE] Option for xllamacpp inference engine","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/194"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOwTw","labels":["enhancement"],"repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"[FEATURE] Option for xllamacpp inference engine","work Package":"WP10: Alternative Inference"},{"content":{"body":"# Story Factory Development Roadmap\n\nThis issue serves as the master overview for all planned development work, organized into **10 work packages** that group logically related issues.\n\n## Work Package Organization\n\nIssues are grouped by **what makes sense to work on together** - same systems, same spirit, synergies between issues. Each work package can be tackled as a cohesive unit.\n\n---\n\n## WP1: LLM Output Handling\n**Spirit:** \"LLM returns garbage, handle it gracefully\"\n\n| Issue | Title |\n|-------|-------|\n| #165 | Concept refinement returns JSON array instead of object |\n| #166 | LLM persistently generates duplicate names |\n| #168 | LLM returns empty responses for entity creation |\n| #176 | Semantic duplicate detection using embeddings |\n| #175 | Circuit breaker pattern for LLM calls |\n\n**Why together:** All deal with handling bad/unexpected LLM output. #176 semantic dedup helps solve #166 duplicate names. #175 circuit breaker handles repeated failures gracefully.\n\n---\n\n## WP2: Refinement Effectiveness\n**Spirit:** \"Make refinement actually improve quality\"\n\n| Issue | Title |\n|-------|-------|\n| #167 | Quality scores plateau at 8.2 - refinement iterations ineffective |\n| #177 | Dynamic temperature adjustment during refinement |\n\n**Why together:** Both address why the refinement loop doesn't improve quality. Plateau detection + dynamic temperature work together to make refinement effective.\n\n---\n\n## WP3: Relationship System\n**Spirit:** \"Everything about entity relationships\"\n\n| Issue | Title |\n|-------|-------|\n| #169 | Relationship generation references non-existent entities |\n| #174 | Dynamic relationship generation based on entity analysis |\n| #190 | Orphan entity detection and warnings |\n| #191 | Circular relationship detection |\n\n**Why together:** All relationship/graph logic. Build dynamic generation alongside validation (orphans, circular refs, bad references) as one coherent system.\n\n---\n\n## WP4: Generation UX\n**Spirit:** \"User visibility and control during generation\"\n\n| Issue | Title |\n|-------|-------|\n| #180 | Cancel button for long-running generations |\n| #185 | Progress bar with estimates during world generation |\n| #171 | Mini description generation lacks logging context |\n\n**Why together:** Cancel button needs progress tracking to show what's being cancelled. Logging supports debugging both.\n\n---\n\n## WP5: Entity Browser UI\n**Spirit:** \"Entity browser improvements\"\n\n| Issue | Title |\n|-------|-------|\n| #181 | Regenerate single entity button |\n| #182 | Search and filter in entity browser |\n| #172 | World map icons should match entity list icons |\n| #173 | Add golden outline to protagonist character icons |\n\n**Why together:** All improve the entity browser experience. Regenerate, search, and visual consistency work together as one better UI.\n\n---\n\n## WP6: World Health & Validation\n**Spirit:** \"Assess and display world quality\"\n\n| Issue | Title |\n|-------|-------|\n| #178 | Entity consistency validation - detect contradictions |\n| #188 | World health dashboard - statistics and diagnostics |\n\n**Why together:** Dashboard displays validation results. Build the validation logic and its visualization together.\n\n---\n\n## WP7: Templates & Content\n**Spirit:** \"Pre-configured generation guidance\"\n\n| Issue | Title |\n|-------|-------|\n| #179 | Character arc templates for protagonist/antagonist generation |\n| #183 | World templates - presets for Fantasy, Sci-Fi, Modern, etc. |\n| #193 | Content guidelines enforcement for generated content |\n\n**Why together:** All guide what gets generated. World templates can include character arc templates and content guidelines as part of the preset.\n\n---\n\n## WP8: Visualizations\n**Spirit:** \"New visualization features\"\n\n| Issue | Title |\n|-------|-------|\n| #186 | Timeline view for events and entity history |\n| #187 | Conflict and tension mapping visualization |\n| #189 | Generation cost tracking - tokens, time, model comparison |\n\n**Why together:** Similar development pattern (new visualization pages). Independent features but similar implementation work.\n\n---\n\n## WP9: Data Integrity\n**Spirit:** \"Data safety and history\"\n\n| Issue | Title |\n|-------|-------|\n| #184 | Entity versioning - track changes and revert |\n| #192 | Backup integrity verification |\n\n**Why together:** Both about data safety. Versioning tracks entity history, backup verification ensures data can be restored.\n\n---\n\n## WP10: Alternative Inference\n**Spirit:** \"Alternative to Ollama\"\n\n| Issue | Title |\n|-------|-------|\n| #194 | [FEATURE] Option for xllamacpp inference engine |\n\n**Standalone:** Major infrastructure addition - XLLamaCPP as alternative inference backend.\n\n---\n\n## Project Board\n\nView the organized board at: https://github.com/users/Aureliolo/projects/2\n\nFilter by \"Work Package\" field to see grouped issues.\n\n---\n\n## Notes\n\n- **#170** (World Generation Quality: Log Analysis Summary) is a meta-issue tracking WP1/WP2 issues - close it when those are resolved\n- Work packages can be worked on in parallel by different contributors\n- Each WP is sized to be a reasonable unit of work for a focused development session","number":195,"repository":"Aureliolo/story-factory","title":"Epic: Story Factory Roadmap - Work Package Overview","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/195"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOxqs","labels":["epic"],"repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"Epic: Story Factory Roadmap - Work Package Overview"},{"content":{"body":"## Overview\nSystematic analysis of world generation logs identified **5 distinct issue types** affecting generation quality and reliability.\n\n## Tracking Checklist\n\n- [ ] #165 - Concept refinement returns JSON array instead of object (CRITICAL)\n- [ ] #166 - LLM persistently generates duplicate names (HIGH)\n- [ ] #167 - Quality scores plateau at 8.2 (MEDIUM)\n- [ ] #168 - LLM returns empty responses (HIGH)\n- [ ] #169 - Relationship references non-existent entities (LOW)\n\n## Issue Summary\n\n| Issue | Severity | Impact | Issue # |\n|-------|----------|--------|---------|\n| Concept refinement returns array instead of object | CRITICAL | 50% concept refinement failures | #165 |\n| LLM persistently generates duplicate names | HIGH | 50% concept generation failures | #166 |\n| Quality scores plateau at 8.2 | MEDIUM | No entities meet 8.5 threshold | #167 |\n| LLM returns empty responses | HIGH | 30+ failed generation attempts | #168 |\n| Relationship references non-existent entities | LOW | Minor data integrity issue | #169 |\n\n## Statistics from single generation run\n\n| Metric | Value |\n|--------|-------|\n| Total ERROR logs | 45+ |\n| Total WARNING logs | 60+ |\n| Concepts requested | 6 |\n| Concepts generated | 3 (50% success) |\n| Factions meeting threshold | 0/7 (0%) |\n| Wasted refinement iterations | ~70 |\n| Duplicate name retries | 30+ |\n\n## Root causes (common themes)\n1. **Prompt clarity** - LLM doesn't understand constraints well\n2. **Model limitations** - smollm2:1.7b may be too small for nuanced tasks\n3. **Validation gaps** - Empty/invalid responses not handled gracefully\n4. **Threshold calibration** - 8.5 threshold unrealistic for current setup\n\n## Recommended priority order\n1. #165 - Fix concept JSON format (quick win)\n2. #166 - Improve duplicate name handling (high impact)\n3. #168 - Handle empty responses gracefully (reliability)\n4. #167 - Calibrate quality thresholds (efficiency)\n5. #169 - Fix relationship entity lookup (polish)\n\n## Verification\nAfter all sub-issues are resolved, re-run world generation and compare metrics to baseline above.","number":170,"repository":"Aureliolo/story-factory","title":"World Generation Quality: Log Analysis Summary","type":"Issue","url":"https://github.com/Aureliolo/story-factory/issues/170"},"id":"PVTI_lAHOASXL7s4BNe0nzgkOx6M","labels":["tracking"],"repository":"https://github.com/Aureliolo/story-factory","status":"Todo","title":"World Generation Quality: Log Analysis Summary"}],"totalCount":31}
